All 7 phases are complete. Here's a summary of everything that was implemented:

## Summary

### Phase 1: Database Trait & ApiKey Migration
- Moved `ApiKey` struct from `flowstate-db` to `flowstate-core/src/api_key.rs`
- Defined async `Database` trait with 39 methods across 7 domains (Projects, Tasks, Claude Runs, Task Links, Task PRs, Attachments, API Keys)
- Created `DbError` enum, `DbConfig` struct, and `open_database()` factory function
- Added feature flags: `sqlite` (default) and `postgres`

### Phase 2: SQLite Submodule Reorganization
- Moved all SQLite code from `src/queries/` to `src/sqlite/queries/`
- Created `SqliteDatabase` struct wrapping `Arc<Mutex<Connection>>`
- All sync methods got `_sync` suffix, called from `spawn_blocking` in trait impl
- Added `SqliteResultExt` trait for rusqlite error conversion

### Phase 3: Consumer Migration
- Updated `flowstate-server` (main.rs, auth.rs, watchdog.rs, claude.rs, all routes) to use `Arc<dyn Database>`
- Updated `flowstate-service/local.rs` to use `Arc<dyn Database>` with `.await`
- Added `.await` to all direct DB calls in route handlers
- Updated Cargo.toml files with `default-features = false` + feature forwarding

### Phase 4: PostgresDatabase Implementation
- Full Postgres backend using `sqlx::PgPool`
- V1 migration SQL covering all tables (equivalent to SQLite v0–v9)
- All 39 Database trait methods implemented with native async sqlx queries
- `FOR UPDATE SKIP LOCKED` for concurrent claim operations
- `#[derive(sqlx::FromRow)]` row structs with conversion to core types

### Phase 5: Backend-Agnostic Testing
- 13 shared test functions in `tests/common/mod.rs` testing through `&dyn Database`
- `sqlite_parity.rs` — runs all 13 against in-memory SQLite
- `postgres_parity.rs` — runs all 13 against Postgres (requires `DATABASE_URL`, `#[ignore]`)

### Phase 6: Nix Integration
- Created `nix/postgres.nix` mirroring `garage.nix` pattern (dev on port 5710, test on 5711)
- Updated `flake.nix` with `server-postgres` package, postgres scripts in devShell, auto-credential loading

### Validation
- **`cargo check --workspace`** — clean
- **`cargo clippy --workspace --all-features -- -D warnings`** — zero warnings
- **57 tests pass** (19 SQLite unit + 13 SQLite parity + 3 runner + 22 store)
